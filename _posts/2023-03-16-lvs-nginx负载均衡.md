---
title: lvs+nginx负载均衡
author: Travis <Hongxu Wei>
date: 2023-03-16 10:23:52 +0800
categories: [DailyNotes Space]
tags: [lvs, nginx]
math: false
---

## 一、四层+七层负载结合方案

四层负载使用lvs软件或F5硬件实现。七层负载使用nginx实现。

如下图是lvs+nginx的拓扑结构：

<img src="https://travisnotes.oss-cn-shanghai.aliyuncs.com/mdpic/202303161015263.png" alt="image-20230316101559193" style="zoom:40%;" />

## 二、nginx集群背景

在keepalived+nginx的主备容灾高可用的架构中，nginx是作为外部访问系统的唯一入口，理论上一台nginx的最大并发量可以高达50000，但是当并发量更大的时候，keepalived+nginx的高可用机制是没办法满足需求的，因为keepalived+nginx的架构中确确实实是一台nginx在工作，只有当master宕机或异常时候，备份机才会上位。那么如何解决更大的高并发问题呢，也许会问能不能搭建nginx集群，直接对外提供访问？

很显然这是欠妥当的，因为当nginx作为外部的唯一访问入口，没办法直接以集群的形式对外提供服务，没有那么多的公网ip资源可用，既太浪费也不友好。但是在内网环境下，是可以用nginx集群（nginx横向扩展服务集合）的，当然总得有一个对外入口，所以需要在nginx集群之上，在加一层负载均衡器，作为系统的唯一入口。

## 三、lvs实现四层负载

 LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。

### 1、lvs实现负载的三种方式

运行 lPVS软件的服务器，在整个负载均衡集群中承担一调度角色 软件的服务器，（即 向真实服务器分配从客户端过来的请求。LVS中的调度方法有三种 ：NAT（Network Address Translation网络地址转换）、TUN（tunnel 隧道）、DR（direct route 直接路由）

#### （a）lvs-DR模式

![img](https://travisnotes.oss-cn-shanghai.aliyuncs.com/mdpic/202303161022504.png)

请求由LVS接受，由真实提供服务的服务器(RealServer, RS)直接返回给用户，返回的时候不经过LVS。

DR模式下需要LVS服务器和RS绑定同一个VIP， 一个请求过来时，LVS只需要将网络帧的MAC地址修改为某一台RS的MAC，该包就会被转发到相应的RS处理，注意此时的源IP和目标IP都没变，RS收到LVS转发来的包，发现MAC是自己的，发现IP也是自己的，于是这个包被合法地接受，而当RS返回响应时，只要直接向源IP(即用户的IP)返回即可，不再经过LVS。

- 优势

  DR模式下，lvs接收请求输入，将请求转发给RS，由RS输出响应给用户，性能非常高。

- 缺点

  它的不足之处是要求负载均衡器与RS在一个物理段上。

#### （b）lvs-NAT模式

<img src="https://travisnotes.oss-cn-shanghai.aliyuncs.com/mdpic/202303161021359.png" alt="img"  />

 NAT(Network Address Translation)是一种外网和内网地址映射的技术。NAT模式下，LVS需要作为RS的网关，当网络包到达LVS时，LVS做目标地址转换(DNAT)，将目标IP改为RS的IP。RS接收到包以后，处理完，返回响应时，源IP是RS IP，目标IP是客户端的IP，这时RS的包通过网关(LVS)中转，LVS会做源地址转换(SNAT)，将包的源地址改为VIP，对于客户端只知道是LVS直接返回给它的。

-  NAT模式请求和响应都需要经过lvs，性能没有DR模式好。

#### （c）lvs-TUN模式

![img](https://travisnotes.oss-cn-shanghai.aliyuncs.com/mdpic/202303161022418.png)

TUN模式是通过ip隧道技术减轻lvs调度服务器的压力，许多Internet服务（例如WEB服务器）的请求包很短小，而应答包通常很大，负载均衡器只负责将请求包分发给物理服务器，而物理服务器将应答包直接发给用户。所以，负载均衡器能处理很巨大的请求量。相比NAT性能要高的多，比DR模式的优点是不限制负载均衡器与RS在一个物理段上。但是它的不足需要所有的服务器（lvs、RS）支持"IP Tunneling"(IP Encapsulation)协议。



## 四、参考资料

[lvs+nginx负载均衡](https://www.cnblogs.com/arjenlee/p/9262737.html)

