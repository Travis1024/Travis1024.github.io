---
title: HLS加密视频播放防止视频泄露方案
author: Travis <Hongxu Wei>
date: 2023-07-04 09:22:32 +0800
categories: [Java Learning Space]
tags: [hls]
math: false
---



## （华为云）场景说明

使用防盗链机制可以控制播放行为，避免非授权用户通过播放URL下载或播放点播视频，但无法阻止恶意的付费用户将视频下载到本地后进行二次分发。

为了有效防止视频泄露和盗链问题，华为云视频点播提供了对HLS视频内容进行加密的能力。加密后的视频，即使恶意用户下载也无法分发给其他人观看。HLS加密涉及到业务侧的密钥服务和Token生成服务的搭建，所以本方案主要适用于能自行搭建一套完整的鉴权及密钥管理服务的业务侧。

## 实现原理

华为云视频点播提供的HLS加密使用的HLS规范中的通用加密方案，通过指定的AES-128加密算法来加密每一个TS，并在生成的m3u8文件中描述播放器如何解密TS文件的方法，支持所有的HLS播放器。

![img](https://travisnotes.oss-cn-shanghai.aliyuncs.com/mdpic/202307040935610.png)

### (1) 加密流程

1. 业务侧将视频上传到点播服务（VOD）后，请求HLS加密。

2. 点播服务收到加密请求后，向KMS请求加密密钥，并将获取的密钥ID和密钥密文存储在点播服务中。

3. 点播服务向媒体处理服务请求HLS加密，媒体处理服务通过转码功能将对应的视频进行加密。

   转码加密后生成的m3u8文件带有“#EXT-X-KEY”标签，该标签包含了**“METHOD”**和**“URI”**属性，其中**“URI”**即为业务侧搭建的密钥管理服务的地址，示例如下所示。

   ```
   #EXTM3U  
   #EXT-X-VERSION:3  
   #EXT-X-TARGETDURATION:6  
   #EXT-X-MEDIA-SEQUENCE:0 
   #EXT-X-KEY:METHOD=AES-128,URI="https://domain-sample/encrypt/get-key?asset_id=6aee80009c4ca6970f508d6334194794",IV=0x80a3ff24ccd788042ca7f2237e74c59d  
   #EXTINF:5.000000,  6aee80009c4ca6970f508d6334194794_1_1920X1080_3000_0_0.ts  
   #EXTINF:5.000000,  6aee80009c4ca6970f508d6334194794_1_1920X1080_3000_0_1.ts  
   #EXT-X-ENDLIST
   ```

4. 加密后，点播服务通过 CDN 将加密的 HLS 视频文件进行加速分发



### (2) 解密流程

1. 终端用户登录播放器终端，业务侧会对终端用户进行身份校验，校验通过后，会为播放终端分配一个Token，并将带Token的播放地址返回给播放器端。

   示例：若转码加密后的HLS视频播放地址为：`https://1280.cdn-vod.huaweicloud.com/input/test.m3u8`，则播放器终端获取的播放地址为：`https://1280.cdn-vod.huaweicloud.com/input/test.m3u8?token={token}`

2. 播放器终端通过带Token的播放URL向CDN请求播放。由于Token是动态的，所以CDN收到请求后，会直接回源到点播服务。点播服务会将请求URL中的Token写入请求的m3u8文件的“URI”中。点播服务返回给CDN的m3u8文件中会携带播放终端的Token值，示例如下所示。

   ```
   #EXTM3U  
   #EXT-X-VERSION:3  
   #EXT-X-TARGETDURATION:6  
   #EXT-X-MEDIA-SEQUENCE:0 
   #EXT-X-KEY:METHOD=AES-128,URI="https://domain-sample/encrypt/get-key?asset_id=6aee80009c4ca6970f508d6334194794&token={token}",IV=0x80a3ff24ccd788042ca7f2237e74c59d  
   #EXTINF:5.000000,  6aee80009c4ca6970f508d6334194794_1_1920X1080_3000_0_0.ts  
   #EXTINF:5.000000,  6aee80009c4ca6970f508d6334194794_1_1920X1080_3000_0_1.ts  
   #EXT-X-ENDLIST
   ```

3. 播放终端解析返回的m3u8文件，得到EXT-X-KEY标签中的**“URI”**内容，向**“URI”**请求密钥。

4. 业务侧的密钥管理服务收到请求后，先验证Token的合法性，若Token合法，则通过调用点播服务的API查询密钥。密钥管理服务可以选择将查询到的密钥缓存在本地，当下次有其它播放终端请求时，可以直接返回，无需每次都向点播服务获取。

5. 密钥管理服务将点播服务返回的密钥返回给播放终端。播放终端通过获取的密钥解密播放m3u8文件。



## 参考

[1、关于HLS加密视频播放安全问题研究](https://juejin.cn/post/7120641532264185886)

[2、媒体处理-音视频 HLS 加密服务设计](https://juejin.cn/post/7066670799259697159)

[3、(华为云) 通过 HLS 加密防止视频泄露](https://support.huaweicloud.com/bestpractice-vod/vod_10_0004.html)