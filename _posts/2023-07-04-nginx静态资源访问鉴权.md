---
title: nginx静态资源访问鉴权
author: Travis <Hongxu Wei>
date: 2023-07-04 9:44:17 +0800
categories: [Java Learning Space]
tags: [token, nginx]
math: false
---



## nginx + nginx-rtmp-moudle 配置

- 下载安装 nginx + nginx-rtmp-moudle 编译工具

  ```shell
  # 有缺少的，后续再下载安装
  sudo apt-get install build-essential libpcre3 libpcre3-dev libssl-dev libtool openssl
  ```

- nginx + nginx-rtmp-module模块下载 + 配置

  ```shell
  cd /usr/local
  mkdir nginx-rtmp
  cd ./nginx-rtmp
  # 下载 nginx
  wget http://nginx.org/download/nginx-1.24.0.tar.gz
  # 下载 nginx-rtmp-moudle 模块
  wget https://github.com/arut/nginx-rtmp-module/archive/refs/heads/master.zip
  # 解压 nginx 
  tar -zxvf nginx-1.24.0.tar.gz --no-same-owner
  # 解压 nginx-rtmp-moudle 模块
  unzip nginx-rtmp-module-master.zip
  
  mv nginx-rtmp-module-master ./nginx-1.24.0
  ```

- 重新编译 nginx（[具体模块信息查看附录](#fulu)）

  ```shell
  # 需要开启的模块加进去
  ./configure --add-module=./nginx-rtmp-module-master --with-http_ssl_module --with-threads --with-ipv6 --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_slice_module
  
  make
  make install
  ```

- 编译好后将 nginx 软连接到 `/usr/bin`

  ```shell
  cd /usr/local/nginx/sbin/
  ln ./nginx /usr/bin
  ```



## 修改 nginx 配置文件

- `vim /usr/local/nginx/conf/nginx.conf`

  ```
  worker_processes  1;
  
  events {
      worker_connections  1024;
  }
  
  # ------------------------------------视频流配置------------------------------------
  rtmp {
      server {
          listen 1935;
          listen [::]:1935 ipv6only=on;    
  
          application live {
              live on;
              record off;
          }
      }
  }
  http {
      server {
          listen 5000;
  
          location /auth {
              proxy_pass http://x.x.x.x:xxx/api/auth/sso/check;
              proxy_pass_request_body off;
              proxy_set_header Content-Length "";
              proxy_set_header X-Original-URL $request_uri;
              proxy_set_header authorization $http_authorization;
          }
          location /hlsvideo {
              # 鉴权
              auth_request /auth;
  
              types {
                  application /vnd.apple.mpegurl m3u8;
                  video /mp2t ts;
              }
  
              #访问权限开启，否则访问这个地址会报403
              autoindex on;
              #视频流存放地址，与上面的hls_path相对应，这里root和alias的区别可自行百度
              root /home/travis;
              expires -1;
              add_header Cache-Control no-cache;
              #防止跨域问题
              add_header 'Access-Control-Allow-Origin' '*';
              add_header 'Access-Control-Allow-Credentials' 'true';
              add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
              add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
          }
      }
  }
  ```
  


## 后端 nginx auth_request 鉴权实现

```java
@ApiOperation(value = "nginx鉴权请求服务")
@GetMapping("/check")
public void nginxAuth(HttpServletRequest request, HttpServletResponse response) {
    String token = request.getHeader(TokenConstants.AUTHENTICATION);
    log.info("token:" + token);
    if (StrUtil.isEmpty(token)) {
        response.setStatus(401);
        return;
    }
    // 验证 token 里面的 userId 是否为空
    String userId = JwtTokenUtil.getUserIdFromToken(token);
    if (StrUtil.isEmpty(userId)) {
        response.setStatus(401);
        return;
    }
    // 对Token解签名，并验证Token是否过期
    boolean isJwtNotValid = JwtTokenUtil.isTokenExpired(token);

    // 如果token已经过期，判断token能够被刷新
    if(isJwtNotValid){
        response.setStatus(401);
        return;
    }
    response.setStatus(200);
}
```



## 问题

- 通过 nginx auth_request进行鉴权，访问一般的静态资源文件，携带`Authorization`请求头访问没有问题。但是对于m3u8视频切片文件，由于播放器原因，目前没有测试成功-请求头携带 token 播放视频，但是不通过播放器能够访问到 m3u8 文件内容，也能够在鉴权后对 ts 切片进行下载。



## 附录

- <span id = 'fulu'>Docker nginx 开启的 configure</span>

  ```
  configure arguments: 
  --prefix=/etc/nginx 
  --sbin-path=/usr/sbin/nginx 
  --modules-path=/usr/lib/nginx/modules 
  --conf-path=/etc/nginx/nginx.conf 
  --error-log-path=/var/log/nginx/error.log 
  --http-log-path=/var/log/nginx/access.log 
  --pid-path=/var/run/nginx.pid 
  --lock-path=/var/run/nginx.lock 
  --http-client-body-temp-path=/var/cache/nginx/client_temp 
  --http-proxy-temp-path=/var/cache/nginx/proxy_temp 
  --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp 
  --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp 
  --http-scgi-temp-path=/var/cache/nginx/scgi_temp 
  --user=nginx 
  --group=nginx 
  --with-compat 
  --with-file-aio 
  --with-threads 
  --with-http_addition_module 
  --with-http_auth_request_module 
  --with-http_dav_module 
  --with-http_flv_module 
  --with-http_gunzip_module 
  --with-http_gzip_static_module 
  --with-http_mp4_module 
  --with-http_random_index_module 
  --with-http_realip_module 
  --with-http_secure_link_module 
  --with-http_slice_module 
  --with-http_ssl_module 
  --with-http_stub_status_module 
  --with-http_sub_module 
  --with-http_v2_module 
  --with-mail 
  --with-mail_ssl_module 
  --with-stream 
  --with-stream_realip_module 
  --with-stream_ssl_module 
  --with-stream_ssl_preread_module 
  --with-cc-opt='-g -O2 -ffile-prefix-map=/data/builder/debuild/nginx-1.21.5/debian/debuild-base/nginx-1.21.5=. -fstack-protector-strong -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fPIC' 
  --with-ld-opt='-Wl,-z,relro -Wl,-z,now -Wl,--as-needed -pie'
  ```

- Docker nginx-rtmp-moudle 开启的 configure

  ```
  configure arguments: 
  --sbin-path=/usr/local/sbin/nginx 
  --conf-path=/etc/nginx/nginx.conf 
  --error-log-path=/var/log/nginx/error.log 
  --pid-path=/var/run/nginx/nginx.pid 
  --lock-path=/var/lock/nginx/nginx.lock 
  --http-log-path=/var/log/nginx/access.log 
  --http-client-body-temp-path=/tmp/nginx-client-body 
  --with-http_ssl_module 
  --with-threads 
  --with-ipv6 
  --add-module=/tmp/build/nginx-rtmp-module/nginx-rtmp-module-1.2.1
  ```

  

## 参考

[1、使用auth_request做权限控制](https://blog.csdn.net/Cross_self/article/details/122579547)

